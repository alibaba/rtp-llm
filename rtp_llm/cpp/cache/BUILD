load("//:def.bzl", "copts")
load("//bazel:arch_select.bzl", "torch_deps")

cc_library(
    name = "cache",
    hdrs = [
        "BatchKVCacheResource.h",
        "BlockCache.h",
        "BlockRefCounter.h",
        "CacheConfigCreator.h",
        "CacheConfig.h",
        "CacheManager.h",
        "KVCacheResource.h",
        "KvCacheInfo.h",
        "DistStorage.h",
        "DistStorageLocalMem.h",
        "DistStorageManager.h",
        "DistKvCachePlanner.h",
        "DistKvCache.h",
        "DistKvCacheMetrics.h",
        "KVCacheAllocator.h",
        "BlockLRUCache.h",
        "WarmUpResult.h",
    ],
    srcs = [
        "BatchKVCacheResource.cc",
        "BlockCache.cc",
        "CacheConfigCreator.cc",
        "CacheManager.cc",
        "KVCacheResource.cc",
        "DistStorageLocalMem.cc",
        "DistStorageManager.cc",
        "DistKvCachePlanner.cc",
        "DistKvCache.cc",
        "KVCacheAllocator.cc",
        "BlockLRUCache.cc",
    ],
    deps = torch_deps() + [
        "//rtp_llm/cpp/metrics:metrics",
        "//rtp_llm/cpp/model_rpc:model_rpc_pool",
        "//rtp_llm/cpp/config:gpt_init_params",
        "//rtp_llm/cpp/utils:core_utils",
        "//rtp_llm/cpp/utils:error_code",
        "//rtp_llm/cpp/utils:time_util",
        "//rtp_llm/cpp/utils:lru_cache",
        "//rtp_llm/cpp/utils:kv_cache_utils",
        "@com_google_absl//absl/status",
        "@com_google_absl//absl/status:statusor",
        "//rtp_llm/cpp/devices:devices_base",
        "//rtp_llm/cpp/devices:device_utils",
        "//rtp_llm/cpp/disaggregate/cache_store:cache_store",
    ] + select({
        "//:enable_3fs": [
            ":storage_3fs",
        ],
        "//conditions:default": [],
    }),
    visibility = ["//visibility:public"],
)

cc_library(
    name = "storage_3fs",
    hdrs = [
        "DistStorage.h",
        "DistStorage3FS.h",
        "DistStorage3FSFile.h",
        "ThreeFSCudaUtil.h",
        "ThreeFSMempool.h",
        "DistKvCacheMetrics.h",
    ],
    srcs = [
        "DistStorage3FS.cc",
        "DistStorage3FSFile.cc",
        "ThreeFSMempool.cc",
    ],
    deps = [
        "//rtp_llm/cpp/utils:core_utils",
        "//rtp_llm/cpp/utils:error_code",
        "//rtp_llm/cpp/utils:time_util",
        "//rtp_llm/cpp/utils:lru_cache",
        "//rtp_llm/cpp/utils:kv_cache_utils",
        "//rtp_llm/cpp/cuda:cuda_host_utils",
        "//3rdparty/3fs:hf3fs",
        "@havenask//aios/autil:lock_free",
        "@havenask//aios/autil:scope",
        "@havenask//aios/kmonitor:kmonitor_client_cpp",
        "@local_config_cuda//cuda:cuda_headers",
    ],
    visibility = ["//visibility:public"],
)