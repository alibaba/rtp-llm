load("//:def.bzl", "copts", "cuda_copts", "rocm_copts")

cc_library(
    name = "kernels_cu",
    srcs = glob([
        "*.cu",
        "decoder_masked_multihead_attention/*.cu",
        "online_softmax_beamsearch/*.cu",
    ], exclude = [
        "layernorm_fp8_kernels.cu",
        "activation_fp8_kernels.cu",
        "unfused_attention_fp8_kernels.cu",
        "moe_kernels.cu",
    ]),
    hdrs = glob([
        "*.h",
        "*.cuh",
        "decoder_masked_multihead_attention/*.h",
        "online_softmax_beamsearch/*.h",
        "online_softmax_beamsearch/*.hpp"
    ], exclude=[
        "AttentionFP8Weight.h",
        "moe_kernels.h",
    ]),
    deps = [
        "//src/fastertransformer/cuda:memory_utils",
        "//src/fastertransformer/cuda:nvtx",
        "//src/fastertransformer/cuda:cuda_utils",
        "//src/fastertransformer/utils:utils",
        "//3rdparty:cub",
        "@local_config_cuda//cuda:cuda",
        "@local_config_cuda//cuda:cudart",
    ],
    copts = cuda_copts(),
    include_prefix = "src",
    visibility = ["//visibility:public"],
)

cc_library(
    name = "kernels",
    hdrs = [
        "_vector_abs_max.h",
        "_convert_from_float.h",
        "_convert_to_float.h",
        "_cast_to_int8.h",
        "_add.h",
        "_mul.h",
        "_fma.h",
        "_sum_dot_zero.h",
        "_logn_attention.h",
        "_convert_from_fp8.h",
        "_convert_to_fp8.h",
    ],
    srcs = glob([
        "*.cc",
        "decoder_masked_multihead_attention/*.cc",
    ], exclude=[
        "**/*_test.cc",
    ]),
    deps = [
        ":kernels_cu",
        "//3rdparty:cuda_driver",
        "//src/fastertransformer/utils:utils",
        "@local_config_cuda//cuda:cuda",
        "@local_config_cuda//cuda:cudart",
    ],
    copts = copts(),
    include_prefix = "src",
    visibility = ["//visibility:public"],
)

cc_library(
    name = "gpt_kernels_rocm",
    srcs = [
        "hello_world.cu",
        "moe_topKSoftmax_kernels.cu",
        "gpt_kernels.cu",
        "add_residual_kernels.cu",
        "alpha_layernorm_kernels.cu",
        "rmsnormKernels.cu",
        "layernorm_kernels.cu",
        "activation_kernels.cu",
        "unfused_attention_kernels.cu",
        "sampling_topk_kernels.cu",
        "sampling_topp_kernels.cu",
        "sampling_penalty_kernels.cu",
        "custom_ar_kernels.cu",
        "decoder_masked_multihead_attention.cu",
        "quantization_tensor.cu",
    ]+glob([
        "decoder_masked_multihead_attention/*.cu",
    ]),
    hdrs = [
        "hello_world.h",
        "moe_topKSoftmax_kernels.h",
        "gpt_kernels.h",
        "add_residual_kernels.h",
        "alpha_layernorm_kernels.h",
        "rmsnormKernels.h",
        "layernorm_kernels.h",
        "activation_kernels.h",
        "kv_cache_utils.h",
        "unfused_attention_kernels.h",
        "decoder_masked_multihead_attention_utils.h",
        "reduce_kernel_utils.cuh",
        "rotary_position_embedding.h",
        "_vector_abs_max.h",
        "_convert_from_float.h",
        "_convert_to_float.h",
        "_cast_to_int8.h",
        "_add.h",
        "_mul.h",
        "_fma.h",
        "_sum_dot_zero.h",
        "_logn_attention.h",
        "_convert_from_fp8.h",
        "_convert_to_fp8.h",
        "sampling_topk_kernels.h",
        "sampling_topp_kernels.h",
        "sampling_penalty_kernels.h",
        "penalty_types.h",
        "decoder_masked_multihead_attention.h",
        "custom_ar_kernels.h",
        "quantization_tensor.h",
    ] + glob([
        "decoder_masked_multihead_attention/*.h",
    ]),
    deps = [
        "@local_config_rocm//rocm:rocm_headers",
        "@local_config_rocm//rocm:hip",
        "//src/fastertransformer/cuda:cuda_utils_rocm",
        "//src/fastertransformer/rocm:memory_utils",
        "//src/fastertransformer/rocm:rocm_utils",
        "//src/fastertransformer/rocm:rocm",
        "//src/fastertransformer/utils:utils",
        "//src/fastertransformer/rocm:rocm_types_hdr",
    ],
    copts = rocm_copts(),
    include_prefix = "src",
    visibility = ["//visibility:public"],
)

cc_library(
    name = "hello_kernel",
    srcs = [
        "hello_world.cu",
    ],
    hdrs = [
        "hello_world.h",
    ],
    deps = [
        "@local_config_rocm//rocm:rocm_headers",
        "@local_config_rocm//rocm:hip",
        "//src/fastertransformer/utils:utils",
        "//src/fastertransformer/cuda:cuda_utils_rocm",
        "//src/fastertransformer/rocm:rocm_types_hdr",
        "//src/fastertransformer/rocm:rocm_utils",
    ],
    copts = rocm_copts(),
    include_prefix = "src",
    visibility = ["//visibility:public"],
)
