# This is a basic workflow to help you get started with Actions

name: CI Request Trigger

# Controls when the workflow will run
on:
  pull_request:
    branches: [ "main" ]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number }}
  cancel-in-progress: true

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "build"
  build:
    # The type of runner that the job will run on
    runs-on: [self-hosted, Linux]
    # work on CI script dir
    defaults:
      run:
        working-directory: .github/scripts
    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v4

      # Runs trigger CI
      - name: Make the script files executable
        run: chmod +x pre-check-CI-result.sh trigger-CI.sh get-CI-result.sh get-branch-info.sh

      # Pre-check if CI already completed
      - name: Pre-check CI status
        id: pre-check
        run: |
          echo "=== Task started at: $(date '+%Y-%m-%d %H:%M:%S') ==="
          COMMIT_ID=$([ "${{ github.event_name }}" == "pull_request" ] && echo "${{ github.event.pull_request.head.sha }}" || echo "${{ github.sha }}")
          echo "Pre-checking CI status for Commit ID: $COMMIT_ID"
          
          if ./pre-check-CI-result.sh "$COMMIT_ID" "${{ secrets.CI_SECRET }}"; then
            echo "skip_ci=true" >> $GITHUB_OUTPUT
            echo "CI already completed, will skip trigger"
          else
            echo "skip_ci=false" >> $GITHUB_OUTPUT
            echo "CI not completed, will trigger new CI"
          fi
      - name: trigger a CI
        if: steps.pre-check.outputs.skip_ci != 'true'
        run: |
          echo "=== Task started at: $(date '+%Y-%m-%d %H:%M:%S') ==="
          COMMIT_ID=$([ "${{ github.event_name }}" == "pull_request" ] && echo "${{ github.event.pull_request.head.sha }}" || echo "${{ github.sha }}")
          echo "Using Commit ID: $COMMIT_ID"
          echo "$GITHUB_REF"
          PR_ID=$(echo "$GITHUB_REF" | sed 's@refs/pull/\([0-9]\+\)/.*@\1@')
          echo "PR ID is $PR_ID"
          ./trigger-CI.sh "$COMMIT_ID" "${{ secrets.CI_SECRET }}" "${{ github.event.pull_request.head.repo.clone_url }}" "$PR_ID" "${{ github.run_id }}"
      - name: Add comment via REST API
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "=== Task started at: $(date '+%Y-%m-%d %H:%M:%S') ==="
          set +e
          PR_ID=${{ github.event.pull_request.number }}
          BRANCH_NAME="open_merge/${PR_ID}"
          echo "BRANCH_NAME is $BRANCH_NAME"
          MAX_ATTEMPTS=6
          SLEEP_INTERVAL=20

          RETRY_COUNT=0
          BRANCH_INFO=""

          while [ $RETRY_COUNT -lt $MAX_ATTEMPTS ]; do
              echo "Attempt $((RETRY_COUNT + 1))/$MAX_ATTEMPTS to get branch info..."
              BRANCH_INFO=$(sh ./get-branch-info.sh "${BRANCH_NAME}")
              if [ $? -eq 0 ]; then
                  echo "Successfully got branch info"
                  break
              fi
              RETRY_COUNT=$((RETRY_COUNT + 1))
              if [ $RETRY_COUNT -lt $MAX_ATTEMPTS ]; then
                  echo "Branch not found, waiting ${SLEEP_INTERVAL} seconds..."
                  sleep $SLEEP_INTERVAL
              fi
          done

          if [ $RETRY_COUNT -eq $MAX_ATTEMPTS ]; then
              echo "Branch ${BRANCH_NAME} not found after ${MAX_ATTEMPTS} attempts, skipping"
              exit 0
          fi

          CURRENT_INTERNAL_COMMITID=$(echo "$BRANCH_INFO" | jq -r '.commit.id')
          echo "current internal commit id is $CURRENT_INTERNAL_COMMITID"
          MAIN_BRANCH_INFO=$(./get-branch-info.sh "main-internal")
          if [ $? -eq 0 ]; then
              MAIN_INTERNAL_COMMITID=$(echo "$MAIN_BRANCH_INFO" | jq -r '.commit.id')
              if [ "${CURRENT_INTERNAL_COMMITID}" != "${MAIN_INTERNAL_COMMITID}" ]; then

                  for attempt in $(seq 1 $MAX_ATTEMPTS); do
                      echo "=== Comment attempt ${attempt}/${MAX_ATTEMPTS} ==="
                      http_code=$(curl -s -w "%{http_code}" -o /tmp/comment_response.txt \
                            -X POST https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments \
                            -H "Authorization: Bearer $GITHUB_TOKEN" \
                            -H "Accept: application/vnd.github.v3+json" \
                            -d '{
                                "body": "internal source has been updated, please review the changes!"
                            }')

                      echo "HTTP Status Code: $http_code"

                      if [ "$http_code" = "200" ] || [ "$http_code" = "201" ]; then
                          echo "Comment posted successfully"
                          break
                      else
                          echo "Failed to post comment (HTTP $http_code)"
                          if [ $attempt -lt $MAX_ATTEMPTS ]; then
                              echo "Will retry in ${SLEEP_INTERVAL} seconds..."
                              sleep $SLEEP_INTERVAL
                          else
                              echo "All attempts failed, but continuing workflow..."
                          fi
                      fi
                  done
              fi
          fi
          exit 0
      # Runs get CI result
      - name: Get CI result
        if: steps.pre-check.outputs.skip_ci != 'true'
        run: |
          echo "=== Task started at: $(date '+%Y-%m-%d %H:%M:%S') ==="
          COMMIT_ID=$([ "${{ github.event_name }}" == "pull_request" ] && echo "${{ github.event.pull_request.head.sha }}" || echo "${{ github.sha }}")
          echo "Using Commit ID: $COMMIT_ID"
          ./get-CI-result.sh "$COMMIT_ID" "${{ secrets.CI_SECRET }}"